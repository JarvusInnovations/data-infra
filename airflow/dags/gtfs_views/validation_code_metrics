operator: operators.SqlToWarehouseOperator
dst_table_name: "views.validation_code_metrics"
dependencies:
  - dim_date
external_dependencies:
  - gtfs_schedule_history2: validation_notices

sql: |
  WITH
  date_range AS (
      SELECT 
          *
          , t2.full_date AS metric_date
      -- TODO: join with agency_names to get name of agency
      FROM `{{ "cal-itp-data-infra.gtfs_schedule_type2.validation_notices" | table }}` t1
      JOIN `{{ "cal-itp-data-infra.views.dim_date" | table }}` t2
      ON t1.calitp_extracted_at <= t2.full_date
          AND COALESCE(t1.calitp_deleted_at, DATE("2099-01-01")) > t2.full_date
          AND t2.full_date >= "2021-05-01" AND t2.full_date <= "2021-06-01"
  )
  SELECT 
      calitp_itp_id
      , calitp_url_number
      , metric_date
      , code
      , severity
      , COUNT(*) AS n_notices
  FROM date_range
  GROUP BY 1, 2, 3, 4, 5
